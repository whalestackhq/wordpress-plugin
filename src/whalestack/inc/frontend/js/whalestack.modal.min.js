!function(o){"object"==typeof module&&"object"==typeof module.exports?o(require("jquery"),window,document):o(jQuery,window,document)}(function(o,t,i,e){var s=[],l=function(){return s.length?s[s.length-1]:null},c=function(){var o,t=!1;for(o=s.length-1;o>=0;o--)s[o].$blocker&&(s[o].$blocker.toggleClass("current",!t).toggleClass("behind",t),t=!0)};o.whalestackmodal=function(t,i){var e,c;if(this.$body=o("body"),this.options=o.extend({},o.whalestackmodal.defaults,i),this.options.doFade=!isNaN(parseInt(this.options.fadeDuration,10)),this.$blocker=null,this.options.closeExisting)for(;o.whalestackmodal.isActive();)o.whalestackmodal.close();if(s.push(this),t.is("a"))if(c=t.attr("href"),this.anchor=t,/^#/.test(c)){if(this.$elm=o(c),1!==this.$elm.length)return null;this.$body.append(this.$elm),this.open()}else this.$elm=o("<div>"),this.$body.append(this.$elm),e=function(o,t){t.elm.remove()},this.showSpinner(),t.trigger(o.whalestackmodal.AJAX_SEND),o.get(c).done(function(i){if(o.whalestackmodal.isActive()){t.trigger(o.whalestackmodal.AJAX_SUCCESS);var s=l();s.$elm.empty().append(i).on(o.whalestackmodal.CLOSE,e),s.hideSpinner(),s.open(),t.trigger(o.whalestackmodal.AJAX_COMPLETE)}}).fail(function(){t.trigger(o.whalestackmodal.AJAX_FAIL),l().hideSpinner(),s.pop(),t.trigger(o.whalestackmodal.AJAX_COMPLETE)});else this.$elm=t,this.anchor=t,this.$body.append(this.$elm),this.open()},o.whalestackmodal.prototype={constructor:o.whalestackmodal,open:function(){var t=this;this.block(),this.anchor.blur(),this.options.doFade?setTimeout(function(){t.show()},this.options.fadeDuration*this.options.fadeDelay):this.show(),o(i).off("keydown.whalestackmodal").on("keydown.whalestackmodal",function(o){var t=l();27===o.which&&t.options.escapeClose&&t.close()}),this.options.clickClose&&this.$blocker.click(function(t){t.target===this&&o.whalestackmodal.close()})},close:function(){s.pop(),this.unblock(),this.hide(),o.whalestackmodal.isActive()||o(i).off("keydown.whalestackmodal")},block:function(){this.$elm.trigger(o.whalestackmodal.BEFORE_BLOCK,[this._ctx()]),this.$body.css("overflow","hidden"),this.$blocker=o('<div class="'+this.options.blockerClass+' blocker current"></div>').appendTo(this.$body),c(),this.options.doFade&&this.$blocker.css("opacity",0).animate({opacity:1},this.options.fadeDuration),this.$elm.trigger(o.whalestackmodal.BLOCK,[this._ctx()])},unblock:function(t){!t&&this.options.doFade?this.$blocker.fadeOut(this.options.fadeDuration,this.unblock.bind(this,!0)):(this.$blocker.children().appendTo(this.$body),this.$blocker.remove(),this.$blocker=null,c(),o.whalestackmodal.isActive()||this.$body.css("overflow",""))},show:function(){this.$elm.trigger(o.whalestackmodal.BEFORE_OPEN,[this._ctx()]),this.options.showClose&&(this.closeButton=o('<a href="#whalestack-close-modal" rel="whalestackmodal:close" class="whalestack-close-modal '+this.options.closeClass+'">'+this.options.closeText+"</a>"),this.$elm.append(this.closeButton)),this.$elm.addClass(this.options.modalClass).appendTo(this.$blocker),this.options.doFade?this.$elm.css({opacity:0,display:"inline-block"}).animate({opacity:1},this.options.fadeDuration):this.$elm.css("display","inline-block"),this.$elm.trigger(o.whalestackmodal.OPEN,[this._ctx()])},hide:function(){this.$elm.trigger(o.whalestackmodal.BEFORE_CLOSE,[this._ctx()]),this.closeButton&&this.closeButton.remove();var t=this;this.options.doFade?this.$elm.fadeOut(this.options.fadeDuration,function(){t.$elm.trigger(o.whalestackmodal.AFTER_CLOSE,[t._ctx()])}):this.$elm.hide(0,function(){t.$elm.trigger(o.whalestackmodal.AFTER_CLOSE,[t._ctx()])}),this.$elm.trigger(o.whalestackmodal.CLOSE,[this._ctx()])},showSpinner:function(){this.options.showSpinner&&(this.spinner=this.spinner||o('<div class="'+this.options.modalClass+'-spinner"></div>').append(this.options.spinnerHtml),this.$body.append(this.spinner),this.spinner.show())},hideSpinner:function(){this.spinner&&this.spinner.remove()},_ctx:function(){return{elm:this.$elm,$elm:this.$elm,$blocker:this.$blocker,options:this.options,$anchor:this.anchor}}},o.whalestackmodal.close=function(t){if(o.whalestackmodal.isActive()){t&&t.preventDefault();var i=l();return i.close(),i.$elm}},o.whalestackmodal.isActive=function(){return s.length>0},o.whalestackmodal.getCurrent=l,o.whalestackmodal.defaults={closeExisting:!0,escapeClose:!1,clickClose:!1,closeText:"Close",closeClass:"",modalClass:"whalestack-modal",blockerClass:"whalestack-jquery-modal",spinnerHtml:'<div class="rect1"></div><div class="rect2"></div><div class="rect3"></div><div class="rect4"></div>',showSpinner:!1,showClose:!0,fadeDuration:null,fadeDelay:1},o.whalestackmodal.BEFORE_BLOCK="whalestackmodal:before-block",o.whalestackmodal.BLOCK="whalestackmodal:block",o.whalestackmodal.BEFORE_OPEN="whalestackmodal:before-open",o.whalestackmodal.OPEN="whalestackmodal:open",o.whalestackmodal.BEFORE_CLOSE="whalestackmodal:before-close",o.whalestackmodal.CLOSE="whalestackmodal:close",o.whalestackmodal.AFTER_CLOSE="whalestackmodal:after-close",o.whalestackmodal.AJAX_SEND="whalestackmodal:ajax:send",o.whalestackmodal.AJAX_SUCCESS="whalestackmodal:ajax:success",o.whalestackmodal.AJAX_FAIL="whalestackmodal:ajax:fail",o.whalestackmodal.AJAX_COMPLETE="whalestackmodal:ajax:complete",o.fn.whalestack_modal=function(t){return 1===this.length&&new o.whalestackmodal(this,t),this},o(i).on("click.whalestackmodal",'a[rel~="whalestackmodal:close"]',o.whalestackmodal.close),o(i).on("click.whalestackmodal",'a[rel~="whalestackmodal:open"]',function(t){t.preventDefault(),o(this).whalestack_modal()})});